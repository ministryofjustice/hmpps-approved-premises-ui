{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{%- from "moj/components/sub-navigation/macro.njk" import mojSubNavigation -%}
{% from "./partials/_readonly-application.njk" import applicationReadonlyView %}
{% from "./partials/_readonly-assessment.njk" import assessmentReadonlyView %}
{% from "./partials/_timeline.njk" import timeline %}
{% from "./partials/_request-a-placement.njk" import requestAPlacement %}
{%- from "moj/components/identity-bar/macro.njk" import mojIdentityBar -%}
{%- from "govuk/components/tag/macro.njk" import govukTag -%}

{% extends "../partials/layout-with-details.njk" %}

{% set pageTitle = applicationName + " - " + pageHeading %}
{% set mainClasses = "app-container govuk-body application--show" %}

{% block beforeContent %}
    {% if backLink %}
    {{ govukBackLink({
        text: "Back",
        href: backLink
    }) }}
    {% endif %}
{% endblock %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-width-container">
            <div class="govuk-grid-column-full">
                {{ mojIdentityBar(ApplyUtils.applicationIdentityBar(application, pageHeading, user)) }}

                {% include "../_messages.njk" %}
                {% set decision = 'not suitable' %}
                {% if application.assessmentDecision === 'accepted' %}
                    {% set decision = 'suitable' %}
                {% endif %}
                {% if application.assessmentDecision %}
                    {% set html %}
                        <p class="govuk-body">Assessed
                            as {{ decision }}: {{ formatDate(application.assessmentDecisionDate) }}
                        </p>
                        {% if application.status !== 'expired' and application.assessmentDecision !== 'rejected' %}
                            <p class="govuk-body">Application expires on: {{ applicationExpiryDate }}</p>
                        {% endif %}
                    {% endset %}

                    {{ govukInsetText({
                        html: html
                    }) }}
                {% endif %}

            </div>

            {% if application.assessmentDecision === 'accepted' and application.status !== 'withdrawn' and application.status !== 'expired' %}
                <form action="{{ paths.placementApplications.create({}) }}" method="post">
                    <input type="hidden" name="_csrf" value="{{ csrfToken }}" />
                    <input type="hidden" name="applicationId" value="{{ application.id }}" />
                    {{ govukButton({
                        text: "Create placement request",
                        preventDoubleClick: true
                    }) }}
                </form>
            {% endif %}

            <div class="govuk-grid-column-full">
                {{ mojSubNavigation({items:tabs}) }}
            </div>

            <div class="govuk-grid-column-full">
                {% if tab === 'timeline' %}

                    {{ timeline(ApplyUtils.mapApplicationTimelineEventsForUi(timelineEvents), application, csrfToken) }}

                    {% elif tab === 'placementRequests' %}

                    {{ requestAPlacement(requestsForPlacement, application, user, csrfToken) }}

                    {% elif tab === 'assessment' %}
                    {{ assessmentReadonlyView(assessment) }}
                {% else %}
                    {{ applicationReadonlyView(application) }}
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

